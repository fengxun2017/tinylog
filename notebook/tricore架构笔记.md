
Tricore 1.6.2 核心架构

# 1 Architecture Overview

## 1.1 Feature Summary

Tricore 的主要特点：
- 32位架构
- 4G 地址空间
- 支持16位 和 32位指令，以减小程序大小
- 大部分指令在一个CPU时钟周期内执行完成
- 分支指令（使用分支预测）
- 中断低延迟，使用快速上下文切换
- 专用于特定应用协处理器的专用接口，允许添加定制指令
- 零开销循环功能
- 双路、单时钟周期、16x16 位乘法累加单元（带可选饱和度，限制数据溢出）
- 可选的浮点运算单元和内存管理单元
- 广泛的位处理能力
- 支持单指令多数据（SIMD）的数据打包运算，支持2个16位数据的运算或4个8位数据的运算
- 灵活的中断优先级方案
- 支持字节和位寻址
- 数据内存和CPU寄存器按小端排序
- 支持内存保护
- 支持调试

## 1.2 Architectural Registers
包含寄存器：
- 32个通用寄存器
- 程序计数器
- 两个 32 位寄存器，包含状态标志、先前执行信息和保护信息（PCXI - 先前上下文信息寄存器，以及 PSW - 程序状态字）

PCXI、PSW 和 PC 寄存器对于存储和恢复任务上下文的过程至关重要。
32个通用寄存器被分为 16 个 32位数据寄存器（D[0]-D[15]）和 16个 32位地址寄存器（A[0]-A[15]）
其中，4个通用寄存器有特殊功能：
- D[15] 被用作隐式数据寄存器 （一些指令会默认使用 D[15]作为数据源或目标）
- A[10] 为栈指针寄存器
- A[11] 为返回地址寄存器
- A[15] 为隐式地址寄存器（一些寻址模式下，会被自动引用）

寄存器 [0H - 7H] 称为“低位寄存器”，寄存器 [8H - FH] 称为“高位寄存器”。

寄存器 A[0]、A[1]、A[8] 和 A[9] 被定义为系统全局寄存器。这些寄存器不包含在高位或低位上下文中，并且不会在调用或中断之间保存和恢复。它们通常由操作系统使用，可以利用它们存储关键的系统信息，避免频繁存取内存，提高性能。
例如：（1）存储调度器（Scheduler）所需的全局变量。（2）在不同任务或不同CPU核心之间传递关键数据，而不会因为上下文切换丢失。（3）由于这些寄存器不受任务切换影响，因此可以用于存储频繁访问的系统数据，减少RAM访问，提高整体计算速度

## 1.3 Data Types
指令集支持以下数据类型的操作：
- Boolean
- Bit String
- Byte
- Signed Fraction
- Address
- Signed / Unsigned Integer
- IEEE-754 Single-Precision Floating-Point （仅支持单精度，编写程序应该注意，非必要使用双精度的场景，应该主动声明使用单精度）

## 1.4 Memory Model
地址位宽为 32 位，可以访问 4GBytes 的统一程序和 I/O 内存。
地址空间被划分位 16 个段，每个段 256MBytes，地址的高 4 位用于选择具体的段。

## 1.5 Addressing Modes

寻址模式允许加载（Load）和存储（Store）指令高效地访问数据结构中的 简单数据元素，例如：
- 记录（Records）
- 随机访问或顺序访问的数组（Randomly and Sequentially Accessed Arrays）
- 栈（Stacks）
- 环形缓冲区（Circular Buffers）

TriCore 体系结构支持七种寻址模式，这些模式可以访问 8 位、16 位、32 位和 64 位宽的简单数据元素。

这些地址模式的设计：
- 支持高效编译 C/C++ 程序，优化指令执行；
- 便捷访问外设寄存器（Peripheral Registers）；
- 优化典型 DSP 数据结构的实现：
    - 滤波器 中的 环形缓冲区（Circular Buffers）
    - 快速傅里叶变换（FFT） 中的 位反转索引（Bit-Reversed Indexing）

对于硬件不直接支持的寻址模式，可以通过短指令序列（Short Instruction Sequences）进行合成。

## 1.6 Tasks and Contexts
在Tricore架构中，任务分为两类：软件管理任务（Software Managed Tasks (SMTs)）和中断服务程序（Interrupt Service Routines (ISRs)）。
SMT由实时内核或操作系统的服务创建，并在调度软件的控制下进行调度。ISR由硬件调度以响应中断。
根据任务的功能，每个任务都会分配自己的模式：
- User-0 Mode：用于那些不访问外设的任务，该模式下不可以打开/关闭中断。
- User-1 Mode：用于那些访问普通，不受保护的外设的任务。通常，包括对串口的读写访问、对定时器的读访问以及大多数 I/O 状态寄存器的读访问。此模式下的任务可能会短时间禁用中断。（此模式的默认行为可能会被系统控制寄存器覆盖。）
- Supervisor Mode: 允许读写系统寄存器和所有外设。使用该模式的任务可以关闭中断。

各个模式主要通过处理器状态字 (PSW) 中的 I/O 模式位启用或禁用。
任何任务都关联有一组状态元素，这些元素统称为任务的上下文。上下文是处理器定义相关任务状态并使其能够继续执行所需的一切。这包括任务使用的 CPU 通用寄存器、任务的程序计数器 (PC) 及其程序状态信息（PCXI 和 PSW）。该架构通过硬件高效地管理和维护任务的上下文。上下文细分为上层上下文和下层上下文。

**上下文保存区**：
该架构使用固定大小的上下文保存区 (CSA) 链表。CSA 由 16 个字的内存存储组成，并按 16 字边界对齐。每个 CSA 只能保存一个上层上下文或一个下层上下文。CSA 通过链接字链接在一起。
该架构比传统的微处理器和微控制器更快地保存和恢复上下文。独特的内存子系统设计和宽数据路径使该架构能够在处理器寄存器和片上存储器之间进行快速数据传输。当事件或指令导致程序执行中断时，就会发生上下文切换。导致程序执行中断的事件和指令包括：
- 中断或服务请求（系统调用）
- 陷阱
- 函数调用

## 1.7 Interrupt System
该架构具有强大而灵活的中断系统。中断系统是围绕  可编程服务请求节点（srn）构建的。  
服务请求被定义为中断请求或DMA（直接内存访问）请求。 服务请求可能来自片上外设、外部硬件软件。

### 1.7.1 Interrupt Priority
服务请求的优先级管理：服务请求采用优先级机制，并允许嵌套中断。优先级规则如下：
- 高优先级的服务请求可以中断低优先级中断的处理过程。
- 具有相同优先级的中断源无法相互打断。
- 中断控制单元（ICU） 根据优先级号进行仲裁，决定哪一个中断源获胜。

所有 服务请求 都会分配 优先级号（SRPN，Service Request Priority Number），每个中断服务程序（ISR）都有独立的优先级号。 **不同的服务请求必须被分配不同的优先级**。


## 1.8 Trap System